{
  "kind": "build_request",
  "title": "Fix APK download by removing placeholder and ensuring reliable APK availability detection",
  "priority": "normal",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Stop shipping an invalid placeholder APK at `frontend/public/downloads/app.apk` by removing the placeholder file from deployed assets so `/downloads/app.apk` returns 404 until a real signed universal APK is provided.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "yes"
        ]
      },
      "acceptanceCriteria": [
        "`frontend/public/downloads/app.apk` is no longer an empty/placeholder file in the deployed frontend assets.",
        "Requesting `/downloads/app.apk` returns HTTP 404 when no real APK is provided.",
        "The `frontend/public/downloads/README.md` guidance remains accurate for the 404 default behavior."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Ensure the asset canister serves APK files with the correct `Content-Type` and strict no-cache headers for `/downloads/app.apk`, including when the URL includes cache-busting query parameters used by the UI availability checks.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "yes"
        ]
      },
      "acceptanceCriteria": [
        "`/downloads/app.apk` is served with `Content-Type: application/vnd.android.package-archive` when present.",
        "`/downloads/app.apk` is served with `Cache-Control: no-cache, no-store, must-revalidate` (and related no-cache headers) when present.",
        "Behavior is consistent for requests like `/downloads/app.apk?t=<timestamp>` (no cached placeholder responses after redeploy)."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Harden frontend APK validation in `frontend/src/hooks/useApkAvailability.ts` so it reliably detects placeholders and error pages even when `Content-Length` is missing or misleading, by performing a small byte-range GET and verifying the APK/ZIP signature (`PK\\x03\\x04`).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "yes"
        ]
      },
      "acceptanceCriteria": [
        "When the server responds with HTML/text (e.g., error page), the hook returns `status: 'invalid'` with an explanatory message.",
        "When the server responds with a very small file (KB range) or a file missing the ZIP signature, the hook returns `status: 'invalid'`.",
        "When a real APK is present (MB range and ZIP signature present), the hook returns `status: 'available'`.",
        "When no APK is hosted (404), the hook returns `status: 'missing'`."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Update the Android APK download dialog (`frontend/src/components/apk/AndroidApkDialog.tsx`) so the Download action remains disabled for missing/invalid/unreachable APKs, and user-facing guidance clearly states the hosted file is missing/invalid and must be replaced with a signed universal APK built via Bubblewrap (English text only).",
      "target": "frontend",
      "source": {
        "messageIds": [
          "msg-1"
        ],
        "quotes": [
          "yes"
        ]
      },
      "acceptanceCriteria": [
        "If APK status is `missing`, `invalid`, or `unreachable`, the \"Download APK\" button is disabled.",
        "If APK status is `missing`, the dialog clearly communicates that no APK is currently hosted and that this is expected until a signed universal APK is deployed.",
        "If APK status is `invalid`, the dialog clearly communicates that the hosted file is not a valid APK (likely placeholder/error page) and provides steps to replace it with a signed universal APK built via Bubblewrap.",
        "All user-facing text in these states is in English."
      ]
    }
  ],
  "constraints": [
    "Do not modify any files under `frontend/src/components/ui` (read-only Shadcn components).",
    "Do not edit immutable hook files listed in `SYSTEM_CONTEXT.frontend.immutablePaths` (compose around them if needed).",
    "Backend must remain single-actor (`backend/main.mo`); only add backend changes if strictly necessary for the APK fix."
  ],
  "nonGoals": [
    "Generating, signing, or providing a real Android APK binary as part of this change.",
    "Adding external hosting, third-party download services, or any backend-based file serving for the APK.",
    "Introducing new authentication providers beyond Internet Identity."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  },
  "userProfileUpdate": {
    "goalsToAdd": [],
    "goalsToRemove": [],
    "preferencesToAdd": [],
    "preferencesToRemove": [],
    "miscToAdd": [],
    "miscToRemove": [],
    "fieldsToSet": {},
    "fieldsToDelete": []
  }
}
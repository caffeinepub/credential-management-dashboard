{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Fix APK download placeholder removal and robust availability validation",
  "requirements": [
    {
      "id": "REQ-1",
      "summary": "Remove the shipped placeholder APK so the downloads URL 404s until a real signed universal APK is provided.",
      "acceptanceCriteria": [
        "`frontend/public/downloads/app.apk` is no longer an empty/placeholder file in the deployed frontend assets.",
        "Requesting `/downloads/app.apk` returns HTTP 404 when no real APK is provided.",
        "The `frontend/public/downloads/README.md` guidance remains accurate for the 404 default behavior."
      ],
      "file_operations": [
        {
          "path": "frontend/public/downloads/app.apk",
          "operation": "delete",
          "description": "Remove the placeholder APK from static assets so the deployed asset canister serves 404 for `/downloads/app.apk` until a real signed universal APK is added."
        },
        {
          "path": "frontend/public/downloads/README.md",
          "operation": "modify",
          "description": "Review and adjust wording (if needed) to ensure guidance explicitly matches the new default behavior: `/downloads/app.apk` returns 404 until a real signed universal APK is placed at `frontend/public/downloads/app.apk` and redeployed."
        },
        {
          "path": "frontend/public/downloads/.gitkeep",
          "operation": "modify",
          "description": "Keep the downloads directory preserved in version control; ensure it remains the only placeholder artifact after removing `app.apk` (no functional change expected)."
        }
      ]
    },
    {
      "id": "REQ-2",
      "summary": "Ensure APK responses have correct content type and strict no-cache headers, and remain reliable with cache-busting query params.",
      "acceptanceCriteria": [
        "`/downloads/app.apk` is served with `Content-Type: application/vnd.android.package-archive` when present.",
        "`/downloads/app.apk` is served with `Cache-Control: no-cache, no-store, must-revalidate` (and related no-cache headers) when present.",
        "Behavior is consistent for requests like `/downloads/app.apk?t=<timestamp>` (no cached placeholder responses after redeploy)."
      ],
      "file_operations": [
        {
          "path": "frontend/public/.ic-assets.json5",
          "operation": "modify",
          "description": "Confirm/adjust asset canister rules so `downloads/app.apk` (and other `downloads/*.apk`) are served with `Content-Type: application/vnd.android.package-archive` and strict no-cache headers; ensure the rules apply regardless of UI cache-busting query parameters."
        },
        {
          "path": "frontend/public/service-worker.js",
          "operation": "modify",
          "description": "Harden the fetch handler for `/downloads/app.apk` so it never caches APK responses and always passes through network responses for requests with cache-busting query parameters and for Range/HEAD/GET checks (avoiding any stale cached responses after redeploy)."
        }
      ]
    },
    {
      "id": "REQ-3",
      "summary": "Make APK availability validation robust by using a byte-range GET and verifying the ZIP/APK signature even when headers are missing or misleading.",
      "acceptanceCriteria": [
        "When the server responds with HTML/text (e.g., error page), the hook returns `status: 'invalid'` with an explanatory message.",
        "When the server responds with a very small file (KB range) or a file missing the ZIP signature, the hook returns `status: 'invalid'`.",
        "When a real APK is present (MB range and ZIP signature present), the hook returns `status: 'available'`.",
        "When no APK is hosted (404), the hook returns `status: 'missing'`."
      ],
      "file_operations": [
        {
          "path": "frontend/src/hooks/useApkAvailability.ts",
          "operation": "modify",
          "description": "Update availability checks to always perform a small byte-range GET (e.g., first 4 bytes) and validate the `PK\\x03\\x04` signature, reliably classifying 404 as `missing`, HTML/text/error bodies as `invalid`, and network failures as `unreachable`, without relying on `Content-Length` being present/accurate."
        }
      ]
    },
    {
      "id": "REQ-4",
      "summary": "Update the Android APK download dialog to keep Download disabled unless a valid APK is available and provide clear English guidance for missing/invalid/unreachable states.",
      "acceptanceCriteria": [
        "If APK status is `missing`, `invalid`, or `unreachable`, the \"Download APK\" button is disabled.",
        "If APK status is `missing`, the dialog clearly communicates that no APK is currently hosted and that this is expected until a signed universal APK is deployed.",
        "If APK status is `invalid`, the dialog clearly communicates that the hosted file is not a valid APK (likely placeholder/error page) and provides steps to replace it with a signed universal APK built via Bubblewrap.",
        "All user-facing text in these states is in English."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/apk/AndroidApkDialog.tsx",
          "operation": "modify",
          "description": "Refine state handling and user-facing copy so Download remains disabled for `missing`/`invalid`/`unreachable`, and the dialog clearly explains how to replace the hosted file with a signed universal APK built via Bubblewrap; add explicit guidance for the `unreachable` case as well, keeping all text English-only. Verify the component's usage instructions before implementing."
        }
      ]
    }
  ]
}